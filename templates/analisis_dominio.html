
{% extends 'base.html' %}
{% block title %}An√°lisis de Dominio | PrestaLabs{% endblock %}
{% block content %}
<div class="container-xl py-3">
	<div class="row mb-4">
		<div class="col-lg-7 mx-auto">
			<div class="card border-0 bg-light mb-4">
				<div class="card-body p-3">
					<h3 class="mb-3 fw-bold text-dark" style="font-size:1.2rem;"><i class="bi bi-globe2 me-2"></i> An√°lisis de Dominio</h3>
					<form id="form-crawling" class="row g-2 align-items-center" style="font-size:0.95em;">
						{% csrf_token %}
						<div class="col-md-7">
							<label for="id_dominio" class="form-label mb-1">Dominio</label>
							<input type="text" name="dominio" maxlength="255" required class="form-control form-control-sm" id="id_dominio" placeholder="ejemplo.com">
							<small class="text-muted">Ejemplo: ejemplo.com</small>
						</div>
						<div class="col-md-3">
							<label for="id_limite_urls" class="form-label mb-1">L√≠mite de URLs</label>
							<input type="number" min="1" name="limite_urls" id="id_limite_urls" class="form-control form-control-sm" placeholder="Ej: 100">
						</div>
						<div class="col-md-2 text-end">
							<button type="submit" class="btn btn-outline-dark btn-sm px-3">Buscar</button>
						</div>
						<div class="col-12 mt-2">
							<div class="alert alert-secondary py-1 mb-0" style="font-size:0.9em;">
								<span class="fw-normal">Si dejas el l√≠mite vac√≠o, el crawling puede demorar mucho y consumir m√°s recursos.</span>
							</div>
						</div>
					</form>
				</div>
			</div>
		</div>
	</div>

	<div class="row mb-4">
		<div class="col-lg-7 mx-auto">
			<div id="ultimo-proceso-mini" class="mb-3"></div>
			<div id="progreso-crawling" class="mb-4">
				<div class="card border-info shadow-sm">
					<div class="card-body">
						<div class="d-flex align-items-center mb-2">
							<span class="me-2" style="font-size:1.5em;color:#0d6efd;">
								<i class="bi bi-globe"></i>
							</span>
							<h5 class="mb-0">Progreso de Crawling</h5>
						</div>
						<div class="progress mb-2" style="height: 1.5rem;">
							<div id="barra-progreso" class="progress-bar progress-bar-striped progress-bar-animated bg-info fw-bold" role="progressbar" style="width: 0%">0%</div>
						</div>
						<div id="barra-info-tiempo" class="mb-2 small"></div>
						<div class="row align-items-center">
							<div class="col-auto">
								<span id="progreso-urls" class="badge bg-primary fs-6">URLs encontradas: 0</span>
							</div>
							<div class="col-auto">
								<span id="progreso-ultima" class="text-muted small"></span>
							</div>
							<div class="col-auto" id="progreso-estado-icono"></div>
						</div>
					</div>
				</div>
			</div>
		</div>
	</div>

	{% if mensaje %}
		<div class="row mb-4">
			<div class="col-lg-10 mx-auto">
				<div class="card border-0 shadow-sm">
					<div class="card-body p-3">
						<h5 class="card-title mb-3">
							<i class="bi bi-info-circle-fill me-2"></i>
							Resultado del An√°lisis
						</h5>
						<div class="mensaje-contenido">
							{{ mensaje|safe }}
						</div>
					</div>
				</div>
			</div>
		</div>
	{% endif %}

	<div class="row">
		<div class="col-lg-10 mx-auto">
			<div class="d-flex justify-content-between align-items-center mb-2">
				<h4 class="fw-bold mb-0"><i class="bi bi-list-check me-2"></i> Historial de b√∫squedas</h4>
				<span class="text-muted">Total registros: {{ dominios_tabla|length }}</span>
			</div>
			<form method="post" action="" id="form-eliminar-busquedas">
				{% csrf_token %}
				<div class="mb-2">
					<input type="checkbox" id="check-todos" class="form-check-input me-2">
					<label for="check-todos" class="form-label mb-0">Seleccionar todos</label>
				</div>
				<div class="card border-0 bg-light mb-4">
					<div class="card-body p-3">
						<div class="table-responsive">
							<table class="table table-hover align-middle bg-white rounded shadow-sm" style="font-size:1em;">
								<thead class="table-light">
									<tr>
										<th class="text-center">#</th>
										<th>Dominio</th>
										<th>Usuario</th>
										<th>Estado</th>
										<th>Inicio</th>
										<th>Fin</th>
										<th>Duraci√≥n</th>
										<th>URLs</th>
										<th class="text-center">Acciones</th>
									</tr>
								</thead>
								<tbody>
									{% for d in dominios_tabla %}
									<tr data-id="{{ d.id }}" style="font-size:1em;">
										<td class="text-center align-middle text-secondary"><input type="checkbox" name="eliminar_ids" value="{{ d.id }}" class="form-check-input eliminar-checkbox"><br>{{ d.id }}</td>
										<td class="align-middle"><span class="fw-bold text-dark">{{ d.dominio }}</span></td>
										<td class="align-middle text-secondary">{{ d.usuario }}</td>
										<td class="align-middle">
											<div class="d-flex flex-column">
												<span class="badge bg-{{ d.estado_clase }} mb-1" style="font-size: 0.75em;">{{ d.estado }}</span>
												{% if d.estado_detalle %}
													<small class="text-muted" style="font-size: 0.7em; line-height: 1.2;">{{ d.estado_detalle }}</small>
												{% endif %}
											</div>
										</td>
										<td class="align-middle text-secondary">{{ d.inicio }}</td>
										<td class="align-middle text-secondary">{{ d.fin }}</td>
										<td class="align-middle text-secondary">{{ d.duracion }}</td>
										<td class="align-middle">
											<div class="d-flex align-items-center">
												<span class="fw-bold {% if d.total_urls == 0 %}text-danger{% else %}text-success{% endif %}">{{ d.total_urls }}</span>
												{% if d.total_urls == 0 and d.estado_clase == 'danger' %}
													<i class="bi bi-shield-fill-exclamation ms-2 text-danger" 
													   data-bs-toggle="tooltip" 
													   data-bs-placement="left"
													   title="üõ°Ô∏è Dominio protegido con anti-bot. Esto es normal para sitios comerciales grandes. Alternativas: APIs oficiales o herramientas especializadas como Screaming Frog."></i>
												{% elif d.total_urls == 0 and d.estado_clase == 'warning' %}
													{% if 'jw.org' in d.dominio %}
														<i class="bi bi-geo-alt ms-2 text-warning" 
														   data-bs-toggle="tooltip" 
														   data-bs-placement="left"
														   title="üîí jw.org implementa restricciones geogr√°ficas y protecci√≥n anti-crawling. Es normal que no permita acceso automatizado. Alternativas: usar VPN de diferentes pa√≠ses o APIs oficiales si est√°n disponibles."></i>
													{% elif 'redlink' in d.dominio or 'hb.' in d.dominio %}
														<i class="bi bi-wifi-off ms-2 text-warning" 
														   data-bs-toggle="tooltip" 
														   data-bs-placement="left"
														   title="üåê Error de conexi√≥n o dominio temporalmente inaccesible. El servidor puede estar ca√≠do o tener problemas de red."></i>
													{% else %}
														<i class="bi bi-exclamation-triangle ms-2 text-warning" 
														   data-bs-toggle="tooltip" 
														   data-bs-placement="left"
														   title="‚ö†Ô∏è Posible problema de conectividad, geobloqueo o timeout. Intentar en otro momento o con VPN."></i>
													{% endif %}
												{% elif d.total_urls == 0 and d.estado_clase == 'info' %}
													<i class="bi bi-search ms-2 text-info" 
													   data-bs-toggle="tooltip" 
													   data-bs-placement="left"
													   title="üîç No se encontr√≥ sitemap.xml o robots.txt accesible. El dominio existe pero no expone informaci√≥n de estructura p√∫blica."></i>
												{% endif %}
											</div>
										</td>
										<td class="text-center align-middle">
											<div class="dropdown">
												<button class="btn btn-light btn-sm dropdown-toggle px-2 py-1" type="button" id="accionesDropdown{{ d.id }}" data-bs-toggle="dropdown" aria-expanded="false">
													<i class="bi bi-three-dots-vertical" style="font-size:1.3em;"></i>
												</button>
												<ul class="dropdown-menu" aria-labelledby="accionesDropdown{{ d.id }}">
													<li>
														<a class="dropdown-item d-flex align-items-center" href="/analisis/detalle/?id={{ d.id }}">
															<i class="bi bi-eye me-2 text-primary"></i> Ver URLs
														</a>
													</li>
													<li>
														<form method="post" action="" style="display:inline;">
															{% csrf_token %}
															<button type="submit" name="eliminar_individual" value="{{ d.id }}" class="dropdown-item d-flex align-items-center">
																<i class="bi bi-trash me-2 text-danger"></i> Eliminar
															</button>
														</form>
													</li>
												</ul>
											</div>
										</td>
									</tr>
									{% empty %}
									<tr><td colspan="9" class="text-center text-muted">No se han buscado dominios a√∫n.</td></tr>
									{% endfor %}
								</tbody>
							</table>
						</div>
					</div>
				</div>
				<button type="submit" name="eliminar_seleccionados" class="btn btn-danger mt-2">Eliminar seleccionados</button>
			</form>

			{% if page_obj.has_other_pages %}
			<nav aria-label="Paginador de dominios" class="mt-3">
				<ul class="pagination justify-content-center">
					{% if page_obj.has_previous %}
						<li class="page-item">
							<a class="page-link" href="?page={{ page_obj.previous_page_number }}" aria-label="Anterior">
								<span aria-hidden="true">&laquo;</span>
							</a>
						</li>
					{% else %}
						<li class="page-item disabled">
							<span class="page-link">&laquo;</span>
						</li>
					{% endif %}
					{% for num in page_obj.paginator.page_range %}
						{% if page_obj.number == num %}
							<li class="page-item active"><span class="page-link">{{ num }}</span></li>
						{% elif num > page_obj.number|add:'-3' and num < page_obj.number|add:'3' %}
							<li class="page-item"><a class="page-link" href="?page={{ num }}">{{ num }}</a></li>
						{% endif %}
					{% endfor %}
					{% if page_obj.has_next %}
						<li class="page-item">
							<a class="page-link" href="?page={{ page_obj.next_page_number }}" aria-label="Siguiente">
								<span aria-hidden="true">&raquo;</span>
							</a>
						</li>
					{% else %}
						<li class="page-item disabled">
							<span class="page-link">&raquo;</span>
						</li>
					{% endif %}
				</ul>
			</nav>
			{% endif %}
		</div>
	</div>
</div>
<script>
// Checkbox maestro para seleccionar/deseleccionar todos
document.addEventListener('DOMContentLoaded', function() {
	// Resumen minimalista y elegante del √∫ltimo proceso
	function cargarUltimoProcesoMini() {
		fetch('/analisis/estado/', {headers: {'X-Requested-With': 'XMLHttpRequest'}})
		.then(r => r.json())
		.then(data => {
			const cont = document.getElementById('ultimo-proceso-mini');
			// Usar data.result si existe, si no data.progreso
			let info = data.result || (data.progreso && Object.keys(data.progreso).length ? data.progreso : null);
			if (!info || !info.dominio) {
				cont.innerHTML = '';
				return;
			}
			let color = 'secondary', estado = 'Desconocido', icon = '';
			if (data.status === 'SUCCESS') {
				color = 'success'; estado = '√âxito';
				icon = `<svg xmlns='http://www.w3.org/2000/svg' width='18' height='18' fill='currentColor' class='bi bi-check-circle-fill me-1' viewBox='0 0 16 16'><path d='M16 8A8 8 0 1 1 0 8a8 8 0 0 1 16 0zM6.97 11.03a.75.75 0 0 0 1.07 0l3.992-3.992a.75.75 0 1 0-1.06-1.06L7.5 9.439 6.03 7.97a.75.75 0 1 0-1.06 1.06l1.5 1.5z'/></svg>`;
			} else if (data.status === 'FAILURE') {
				color = 'danger'; estado = 'Error';
				icon = `<svg xmlns='http://www.w3.org/2000/svg' width='18' height='18' fill='currentColor' class='bi bi-x-circle-fill me-1' viewBox='0 0 16 16'><path d='M16 8A8 8 0 1 1 0 8a8 8 0 0 1 16 0zM4.646 4.646a.5.5 0 0 1 .708 0L8 7.293l2.646-2.647a.5.5 0 0 1 .708.708L8.707 8l2.647 2.646a.5.5 0 0 1-.708.708L8 8.707l-2.646 2.647a.5.5 0 0 1-.708-.708L7.293 8 4.646 5.354a.5.5 0 0 1 0-.708z'/></svg>`;
			} else if (data.status === 'REVOKED') {
				color = 'warning'; estado = 'Cancelado';
				icon = `<svg xmlns='http://www.w3.org/2000/svg' width='18' height='18' fill='currentColor' class='bi bi-exclamation-triangle-fill me-1' viewBox='0 0 16 16'><path d='M8 0c-.69 0-1.342.352-1.732.928L.165 13.233C-.226 13.81.226 14.5.893 14.5h14.214c.667 0 1.119-.69.728-1.267L9.732.928A1.99 1.99 0 0 0 8 0zm.93 4.412-1 6A.5.5 0 0 1 7.5 11h-1a.5.5 0 0 1-.5-.588l1-6A.5.5 0 0 1 7.5 4h1a.5.5 0 0 1 .5.588zM8 13a1 1 0 1 1 0-2 1 1 0 0 1 0 2z'/></svg>`;
			} else {
				color = 'info'; estado = 'En progreso';
				icon = `<svg xmlns='http://www.w3.org/2000/svg' width='18' height='18' fill='currentColor' class='bi bi-arrow-repeat me-1' viewBox='0 0 16 16'><path d='M2 2a.5.5 0 0 1 .5.5V5a.5.5 0 0 1-1 0V2.707l-.146.147a.5.5 0 0 1-.708-.708l1-1a.5.5 0 0 1 .708 0l1 1a.5.5 0 0 1-.708.708L2.5 2.707V5a.5.5 0 0 1-1 0V2.5A.5.5 0 0 1 2 2zm12 12a.5.5 0 0 1-.5-.5V11a.5.5 0 0 1 1 0v2.293l.146-.147a.5.5 0 0 1 .708.708l-1 1a.5.5 0 0 1-.708 0l-1-1a.5.5 0 0 1 .708-.708l.146.147V11a.5.5 0 0 1 1 0v2.5a.5.5 0 0 1-.5.5z'/></svg>`;
			}
			// Formatear fecha/hora a YYYY-MM-DD HH:MM:SS
			function formatFecha(fechaStr) {
				if (!fechaStr) return '';
				// Espera formato 'YYYY-MM-DD HH:MM:SS' o similar
				let d = new Date(fechaStr.replace(' ', 'T'));
				if (isNaN(d)) return fechaStr;
				let y = d.getFullYear();
				let m = (d.getMonth()+1).toString().padStart(2,'0');
				let day = d.getDate().toString().padStart(2,'0');
				let h = d.getHours().toString().padStart(2,'0');
				let min = d.getMinutes().toString().padStart(2,'0');
				let s = d.getSeconds().toString().padStart(2,'0');
				return `${y}-${m}-${day} ${h}:${min}:${s}`;
			}
			// Formatear duraci√≥n tipo '0:00:01.123456' o similar a hh:mm:ss
			function formatDuracion(dur) {
				if (!dur) return '';
				// Si es negativo o raro, mostrar '-'
				if (dur.includes('-')) return '-';
				let partes = dur.split(':');
				if (partes.length < 3) return dur;
				let h = partes[0].padStart(2,'0');
				let m = partes[1].padStart(2,'0');
				let s = partes[2].split('.')[0].padStart(2,'0');
				return `${h}:${m}:${s}`;
			}
			let fecha = info.hora_inicio ? formatFecha(info.hora_inicio) : (info.timestamp ? formatFecha(info.timestamp) : '');
			let fin = info.hora_fin ? formatFecha(info.hora_fin) : '';
			let duracion = info.duracion ? formatDuracion(info.duracion) : '';
			let dominio = info.dominio || '';
			let msg = data.error ? data.error : (data.status === 'SUCCESS' ? 'Finalizado correctamente' : '');
			cont.innerHTML = `
			<div class='card border-0 shadow-sm bg-light' style='max-width:700px;'>
				<div class='card-body p-3'>
					<h4 class='mb-2 fw-bold text-dark text-center' style='font-size:1.5rem;word-break:break-all;'>
						<span class='text-dark'>${dominio}</span>
					</h4>
					<div class='text-center p-0 m-0' style='font-size:0.85em;line-height:1.1;'>
						<span style='margin-right:10px;' class='text-dark'>ID: <strong>${info.id || ''}</strong></span>
						<span style='margin-right:10px;' class='text-dark'>Usuario: <strong>${info.usuario || '-'}</strong></span>
						<span style='margin-right:10px;' class='text-dark'>Estado: <strong>${estado}</strong></span>
						<span style='margin-right:10px;' class='text-dark'>Inicio: <strong>${fecha}</strong></span>
						${fin ? `<span style='margin-right:10px;' class='text-dark'>Fin: <strong>${fin}</strong></span>` : ''}
						${duracion ? `<span style='margin-right:10px;' class='text-dark'>Duraci√≥n: <strong>${duracion}</strong></span>` : ''}
						<span style='margin-right:10px;' class='text-dark'>URLs: <strong>${info.total_urls || 0}</strong></span>
					</div>
					<div class='text-center mt-2'><span class='text-dark'>${msg}</span></div>
				</div>
			</div>`;
		});
	}
	cargarUltimoProcesoMini();
	const checkTodos = document.getElementById('check-todos');
	const checks = document.querySelectorAll('.eliminar-checkbox');
	if (checkTodos) {
		checkTodos.addEventListener('change', function() {
			checks.forEach(chk => { chk.checked = checkTodos.checked; });
		});
	}

	// Progreso siempre visible: cargar √∫ltimo progreso si existe
	function cargarUltimoProgreso() {
		fetch('/analisis/estado/', {headers: {'X-Requested-With': 'XMLHttpRequest'}})
		.then(r => r.json())
		.then(data => {
			const barraProgreso = document.getElementById('barra-progreso');
			const spanUrls = document.getElementById('progreso-urls');
			const spanUltima = document.getElementById('progreso-ultima');
			const divProgreso = document.getElementById('progreso-crawling');
			let total = data.progreso && data.progreso.total ? data.progreso.total : 0;
			let urls = data.progreso && data.progreso.urls ? data.progreso.urls : [];
			let ultima = urls.length > 0 ? urls[urls.length-1] : '';
			let porcentaje = data.progreso && data.progreso.porcentaje ? data.progreso.porcentaje : (total > 0 ? Math.min(100, total) : 0);
			barraProgreso.style.width = porcentaje + '%';
			barraProgreso.textContent = porcentaje + '%';
			spanUrls.textContent = 'URLs encontradas: ' + total;
			spanUltima.textContent = ultima ? '√öltima: ' + ultima : '';

			// Ocultar progreso si termin√≥
			if (["SUCCESS", "FAILURE", "REVOKED"].includes(data.status)) {
				divProgreso.style.display = 'none';
			} else {
				divProgreso.style.display = '';
			}
			// Mostrar hora inicio, fin y duraci√≥n si existen
			let info = data.result || (data.progreso && Object.keys(data.progreso).length ? data.progreso : null);
			const barraInfo = document.getElementById('barra-info-tiempo');
			if (barraInfo && info) {
				let inicio = info.hora_inicio || '';
				let fin = info.hora_fin || '';
				let duracion = info.duracion || '';
				barraInfo.innerHTML = `<span class='text-muted me-2'>Inicio: ${inicio}</span>` +
					(fin ? `<span class='text-muted me-2'>Fin: ${fin}</span>` : '') +
					(duracion ? `<span class='text-muted'>Duraci√≥n: ${duracion}</span>` : '');
			}
			const estadoIcono = document.getElementById('progreso-estado-icono');
			// No recargar aqu√≠, solo actualizar visualmente
			if (data.status === 'SUCCESS') {
				estadoIcono.innerHTML = '<span class="badge bg-success"><svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="currentColor" class="bi bi-check-circle-fill me-1" viewBox="0 0 16 16"><path d="M16 8A8 8 0 1 1 0 8a8 8 0 0 1 16 0zM6.97 11.03a.75.75 0 0 0 1.07 0l3.992-3.992a.75.75 0 1 0-1.06-1.06L7.5 9.439 6.03 7.97a.75.75 0 1 0-1.06 1.06l1.5 1.5z"/></svg>Completado</span>';
			} else if (data.status === 'FAILURE') {
				estadoIcono.innerHTML = '<span class="badge bg-danger"><svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="currentColor" class="bi bi-x-circle-fill me-1" viewBox="0 0 16 16"><path d="M16 8A8 8 0 1 1 0 8a8 8 0 0 1 16 0zM4.646 4.646a.5.5 0 0 1 .708 0L8 7.293l2.646-2.647a.5.5 0 0 1 .708.708L8.707 8l2.647 2.646a.5.5 0 0 1-.708.708L8 8.707l-2.646 2.647a.5.5 0 0 1-.708-.708L7.293 8 4.646 5.354a.5.5 0 0 1 0-.708z"/></svg>Error</span>';
			} else if (data.status === 'REVOKED') {
				estadoIcono.innerHTML = '<span class="badge bg-warning text-dark"><svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="currentColor" class="bi bi-exclamation-triangle-fill me-1" viewBox="0 0 16 16"><path d="M8 0c-.69 0-1.342.352-1.732.928L.165 13.233C-.226 13.81.226 14.5.893 14.5h14.214c.667 0 1.119-.69.728-1.267L9.732.928A1.99 1.99 0 0 0 8 0zm.93 4.412-1 6A.5.5 0 0 1 7.5 11h-1a.5.5 0 0 1-.5-.588l1-6A.5.5 0 0 1 7.5 4h1a.5.5 0 0 1 .5.588zM8 13a1 1 0 1 1 0-2 1 1 0 0 1 0 2z"/></svg>Cancelado</span>';
			} else {
				estadoIcono.innerHTML = '<span class="badge bg-info text-dark"><svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="currentColor" class="bi bi-arrow-repeat me-1" viewBox="0 0 16 16"><path d="M2 2a.5.5 0 0 1 .5.5V5a.5.5 0 0 1-1 0V2.707l-.146.147a.5.5 0 0 1-.708-.708l1-1a.5.5 0 0 1 .708 0l1 1a.5.5 0 0 1-.708.708L2.5 2.707V5a.5.5 0 0 1-1 0V2.5A.5.5 0 0 1 2 2zm12 12a.5.5 0 0 1-.5-.5V11a.5.5 0 0 1 1 0v2.293l.146-.147a.5.5 0 0 1 .708.708l-1 1a.5.5 0 0 1-.708 0l-1-1a.5.5 0 0 1 .708-.708l.146.147V11a.5.5 0 0 1 1 0v2.5a.5.5 0 0 1-.5.5z"/></svg>En progreso</span>';
			}
		});
	}
	cargarUltimoProgreso();

	// AJAX crawling con progreso (igual que antes)
	const formCrawling = document.getElementById('form-crawling');
	const barraProgreso = document.getElementById('barra-progreso');
	const divProgreso = document.getElementById('progreso-crawling');
	const spanUrls = document.getElementById('progreso-urls');
	const spanUltima = document.getElementById('progreso-ultima');
	let polling = null;

	formCrawling.addEventListener('submit', function(e) {
		e.preventDefault();
		const formData = new FormData(formCrawling);
		barraProgreso.style.width = '0%';
		barraProgreso.textContent = '0%';
		spanUrls.textContent = 'URLs encontradas: 0';
		spanUltima.textContent = '';
		// Mostrar la tarjeta de progreso al iniciar una nueva b√∫squeda
		divProgreso.style.display = '';
		if (polling) clearInterval(polling);

		fetch('/crawling/iniciar/', {
			method: 'POST',
			headers: {
				'X-CSRFToken': formData.get('csrfmiddlewaretoken')
			},
			body: formData
		})
		.then(resp => resp.json())
		.then(data => {
			if (data.progress_key) {
				polling = setInterval(() => {
					fetch(`/crawling/progreso/?progress_key=${data.progress_key}`)
						.then(r => r.json())
						.then(prog => {
							let count = prog.count || 0;
							let done = prog.done;
							let last = prog.last || '';
							let percent = done ? 100 : Math.min(99, count);
							barraProgreso.style.width = percent + '%';
							barraProgreso.textContent = percent + '%';
							spanUrls.textContent = `URLs encontradas: ${count}`;
							spanUltima.textContent = last ? `√öltima: ${last}` : '';
							if (done) {
								barraProgreso.style.width = '100%';
								barraProgreso.textContent = '100%';
								clearInterval(polling);
								// Recargar la p√°gina para mostrar los datos actualizados
								setTimeout(() => { window.location.reload(); }, 1200);
							}
						});
				}, 1000);
			}
		});
	});
	
	// Inicializar tooltips de Bootstrap
	const tooltipTriggerList = document.querySelectorAll('[data-bs-toggle="tooltip"]');
	const tooltipList = [...tooltipTriggerList].map(tooltipTriggerEl => new bootstrap.Tooltip(tooltipTriggerEl));
});
</script>
{% endblock %}