
{% extends 'base.html' %}
{% block title %}An√°lisis de Dominio | PrestaLabs{% endblock %}
{% block content %}
<div class="container-xl py-3">
	<div class="row mb-4">
		<div class="col-lg-7 mx-auto">
			<div class="card border-0 bg-light mb-4">
				<div class="card-body p-3">
					<h3 class="mb-3 fw-bold text-dark" style="font-size:1.2rem;">
						<i class="bi bi-globe2 me-2"></i> An√°lisis de Dominios
					</h3>
					
					<!-- Formulario de an√°lisis individual -->
					<form id="form-crawling" class="row g-2 align-items-center mb-4" style="font-size:0.95em;">
						{% csrf_token %}
						<div class="col-md-7">
							<label for="id_dominio" class="form-label mb-1">
								<i class="bi bi-globe me-1"></i>Dominio Individual
							</label>
							<input type="text" name="dominio" maxlength="255" required class="form-control form-control-sm" id="id_dominio" placeholder="ejemplo.com">
							<small class="text-muted">Ejemplo: ejemplo.com</small>
						</div>
						<div class="col-md-3">
							<label for="id_limite_urls" class="form-label mb-1">L√≠mite de URLs</label>
							<input type="number" min="1" name="limite_urls" id="id_limite_urls" class="form-control form-control-sm" placeholder="Ej: 100">
						</div>
						<div class="col-md-2 text-end">
							<label class="form-label mb-1 text-white">.</label>
							<button type="submit" class="btn btn-primary btn-sm px-3 w-100">
								<i class="bi bi-search me-1"></i>Analizar
							</button>
						</div>
					</form>

					<!-- Separador -->
					<div class="text-center mb-3">
						<span class="badge bg-success px-3 py-2">
							<i class="bi bi-lightning-fill me-1"></i>¬°NUEVO! An√°lisis M√∫ltiple
						</span>
					</div>

					<!-- Formulario de an√°lisis m√∫ltiple -->
					<form id="form-crawling-multiple" class="row g-3" style="font-size:0.95em;">
						{% csrf_token %}
						<div class="col-md-8">
							<label for="id_dominios_multiple" class="form-label mb-1">
								<i class="bi bi-list-ul me-1"></i>M√∫ltiples Dominios
							</label>
							<textarea name="dominios_multiple" rows="4" class="form-control form-control-sm" id="id_dominios_multiple" placeholder="argentina.gob.ar&#10;bna.com.ar&#10;infobae.com&#10;lanacion.com.ar"></textarea>
							<small class="text-muted">
								<i class="bi bi-info-circle me-1"></i>Un dominio por l√≠nea. M√°ximo 10 dominios.
								<button type="button" class="btn btn-link btn-sm p-0 ms-2" onclick="cargarEjemplos('gubernamentales')" title="Cargar ejemplos">
									<i class="bi bi-magic"></i> Ejemplos
								</button>
							</small>
						</div>
						<div class="col-md-2">
							<label for="id_limite_urls_multiple" class="form-label mb-1">URLs/dominio</label>
							<input type="number" min="1" max="200" name="limite_urls_multiple" id="id_limite_urls_multiple" class="form-control form-control-sm" placeholder="50" value="50">
							<small class="text-muted">Max: 200</small>
						</div>
						<div class="col-md-2 text-end">
							<label class="form-label mb-1 text-white">.</label>
							<button type="submit" class="btn btn-success btn-sm w-100">
								<i class="bi bi-lightning-charge me-1"></i>M√∫ltiples
							</button>
						</div>
					</form>
				</div>
			</div>
		</div>
	</div>

	<div class="row mb-4">
		<div class="col-lg-7 mx-auto">
			<div id="ultimo-proceso-mini" class="mb-3"></div>
			<div id="progreso-crawling" class="mb-4">
				<div class="card border-info shadow-sm">
					<div class="card-body">
					<div class="d-flex align-items-center justify-content-between mb-2">
						<div class="d-flex align-items-center">
							<span class="me-2" style="font-size:1.5em;color:#0d6efd;">
								<i class="bi bi-globe"></i>
							</span>
							<h5 class="mb-0">Progreso de Crawling</h5>
						</div>
						<button id="btn-detener-crawling" class="btn btn-danger btn-sm">
							<i class="bi bi-stop-circle me-1"></i>Detener
						</button>
						</div>
						<div class="progress mb-2" style="height: 1.5rem;">
							<div id="barra-progreso" class="progress-bar progress-bar-striped progress-bar-animated bg-info fw-bold" role="progressbar" style="width: 0%">0%</div>
						</div>
						<div id="barra-info-tiempo" class="mb-2 small"></div>
						<div class="row align-items-center">
							<div class="col-auto">
								<span id="progreso-urls" class="badge bg-primary fs-6">URLs encontradas: 0</span>
							</div>
							<div class="col-auto">
								<span id="progreso-ultima" class="text-muted small"></span>
							</div>
							<div class="col-auto" id="progreso-estado-icono"></div>
						</div>
						<div id="urls-encontradas" class="mt-3" style="display: none;">
							<h6 class="text-muted mb-2"><i class="bi bi-list-ul"></i> URLs Encontradas en Tiempo Real:</h6>
							<div id="urls-lista" class="border rounded p-2 bg-light" style="max-height: 250px; overflow-y: auto; font-size: 0.85em;">
								<div class="text-muted text-center py-2">Las URLs aparecer√°n aqu√≠ durante el crawling...</div>
							</div>
						</div>
					</div>
				</div>
			</div>
		</div>
	</div>

	{% if mensaje %}
		<div class="row mb-4">
			<div class="col-lg-10 mx-auto">
				<div class="card border-0 shadow-sm">
					<div class="card-body p-3">
						<h5 class="card-title mb-3">
							<i class="bi bi-info-circle-fill me-2"></i>
							Resultado del An√°lisis
						</h5>
						<div class="mensaje-contenido">
							{{ mensaje|safe }}
						</div>
					</div>
				</div>
			</div>
		</div>
	{% endif %}

	<div class="row">
		<div class="col-lg-10 mx-auto">
			<div class="d-flex justify-content-between align-items-center mb-2">
				<h4 class="fw-bold mb-0"><i class="bi bi-list-check me-2"></i> Historial de b√∫squedas</h4>
				<span class="text-muted">Total registros: {{ dominios_tabla|length }}</span>
			</div>
			<form method="post" action="" id="form-eliminar-busquedas">
				{% csrf_token %}
				<div class="mb-2">
					<input type="checkbox" id="check-todos" class="form-check-input me-2">
					<label for="check-todos" class="form-label mb-0">Seleccionar todos</label>
				</div>
				<div class="card border-0 bg-light mb-4">
					<div class="card-body p-3">
						<div class="table-responsive">
							<table class="table table-hover align-middle bg-white rounded shadow-sm" style="font-size:1em;">
								<thead class="table-light">
									<tr>
										<th class="text-center">#</th>
										<th>Dominio</th>
										<th>Usuario</th>
										<th>Estado</th>
										<th>Inicio</th>
										<th>Fin</th>
										<th>Duraci√≥n</th>
										<th>URLs</th>
										<th class="text-center">Acciones</th>
									</tr>
								</thead>
								<tbody>
									{% for d in dominios_tabla %}
									<tr data-id="{{ d.id }}" style="font-size:1em;">
										<td class="text-center align-middle text-secondary"><input type="checkbox" name="eliminar_ids" value="{{ d.id }}" class="form-check-input eliminar-checkbox"><br>{{ d.id }}</td>
										<td class="align-middle"><span class="fw-bold text-dark">{{ d.dominio }}</span></td>
										<td class="align-middle text-secondary">{{ d.usuario }}</td>
										<td class="align-middle">
											<div class="d-flex flex-column">
												<span class="badge bg-{{ d.estado_clase }} mb-1" style="font-size: 0.75em;">{{ d.estado }}</span>
												{% if d.estado_detalle %}
													<small class="text-muted" style="font-size: 0.7em; line-height: 1.2;">{{ d.estado_detalle }}</small>
												{% endif %}
											</div>
										</td>
										<td class="align-middle text-secondary">{{ d.inicio }}</td>
										<td class="align-middle text-secondary">{{ d.fin }}</td>
										<td class="align-middle text-secondary">{{ d.duracion }}</td>
										<td class="align-middle">
											<div class="d-flex align-items-center">
												<span class="fw-bold {% if d.total_urls == 0 %}text-danger{% else %}text-success{% endif %}">{{ d.total_urls }}</span>
												{% if d.total_urls == 0 and d.estado_clase == 'danger' %}
													<i class="bi bi-shield-fill-exclamation ms-2 text-danger" 
													   data-bs-toggle="tooltip" 
													   data-bs-placement="left"
													   title="üõ°Ô∏è Dominio protegido con anti-bot. Esto es normal para sitios comerciales grandes. Alternativas: APIs oficiales o herramientas especializadas como Screaming Frog."></i>
												{% elif d.total_urls == 0 and d.estado_clase == 'warning' %}
													{% if 'jw.org' in d.dominio %}
														<i class="bi bi-geo-alt ms-2 text-warning" 
														   data-bs-toggle="tooltip" 
														   data-bs-placement="left"
														   title="üîí jw.org implementa restricciones geogr√°ficas y protecci√≥n anti-crawling. Es normal que no permita acceso automatizado. Alternativas: usar VPN de diferentes pa√≠ses o APIs oficiales si est√°n disponibles."></i>
													{% elif 'redlink' in d.dominio or 'hb.' in d.dominio %}
														<i class="bi bi-wifi-off ms-2 text-warning" 
														   data-bs-toggle="tooltip" 
														   data-bs-placement="left"
														   title="üåê Error de conexi√≥n o dominio temporalmente inaccesible. El servidor puede estar ca√≠do o tener problemas de red."></i>
													{% else %}
														<i class="bi bi-exclamation-triangle ms-2 text-warning" 
														   data-bs-toggle="tooltip" 
														   data-bs-placement="left"
														   title="‚ö†Ô∏è Posible problema de conectividad, geobloqueo o timeout. Intentar en otro momento o con VPN."></i>
													{% endif %}
												{% elif d.total_urls == 0 and d.estado_clase == 'info' %}
													<i class="bi bi-search ms-2 text-info" 
													   data-bs-toggle="tooltip" 
													   data-bs-placement="left"
													   title="üîç No se encontr√≥ sitemap.xml o robots.txt accesible. El dominio existe pero no expone informaci√≥n de estructura p√∫blica."></i>
												{% endif %}
											</div>
										</td>
										<td class="text-center align-middle">
											<div class="dropdown">
												<button class="btn btn-light btn-sm dropdown-toggle px-2 py-1" type="button" id="accionesDropdown{{ d.id }}" data-bs-toggle="dropdown" aria-expanded="false">
													<i class="bi bi-three-dots-vertical" style="font-size:1.3em;"></i>
												</button>
												<ul class="dropdown-menu" aria-labelledby="accionesDropdown{{ d.id }}">
													<li>
														<a class="dropdown-item d-flex align-items-center" href="/analisis/detalle/?id={{ d.id }}">
															<i class="bi bi-eye me-2 text-primary"></i> Ver URLs
														</a>
													</li>
													<li>
														<form method="post" action="" style="display:inline;">
															{% csrf_token %}
															<button type="submit" name="eliminar_individual" value="{{ d.id }}" class="dropdown-item d-flex align-items-center">
																<i class="bi bi-trash me-2 text-danger"></i> Eliminar
															</button>
														</form>
													</li>
												</ul>
											</div>
										</td>
									</tr>
									{% empty %}
									<tr><td colspan="9" class="text-center text-muted">No se han buscado dominios a√∫n.</td></tr>
									{% endfor %}
								</tbody>
							</table>
						</div>
					</div>
				</div>
				<button type="submit" name="eliminar_seleccionados" class="btn btn-danger mt-2">Eliminar seleccionados</button>
			</form>

			{% if page_obj.has_other_pages %}
			<nav aria-label="Paginador de dominios" class="mt-3">
				<ul class="pagination justify-content-center">
					{% if page_obj.has_previous %}
						<li class="page-item">
							<a class="page-link" href="?page={{ page_obj.previous_page_number }}" aria-label="Anterior">
								<span aria-hidden="true">&laquo;</span>
							</a>
						</li>
					{% else %}
						<li class="page-item disabled">
							<span class="page-link">&laquo;</span>
						</li>
					{% endif %}
					{% for num in page_obj.paginator.page_range %}
						{% if page_obj.number == num %}
							<li class="page-item active"><span class="page-link">{{ num }}</span></li>
						{% elif num > page_obj.number|add:'-3' and num < page_obj.number|add:'3' %}
							<li class="page-item"><a class="page-link" href="?page={{ num }}">{{ num }}</a></li>
						{% endif %}
					{% endfor %}
					{% if page_obj.has_next %}
						<li class="page-item">
							<a class="page-link" href="?page={{ page_obj.next_page_number }}" aria-label="Siguiente">
								<span aria-hidden="true">&raquo;</span>
							</a>
						</li>
					{% else %}
						<li class="page-item disabled">
							<span class="page-link">&raquo;</span>
						</li>
					{% endif %}
				</ul>
			</nav>
			{% endif %}
		</div>
	</div>
</div>
<script>
// Checkbox maestro para seleccionar/deseleccionar todos
document.addEventListener('DOMContentLoaded', function() {
	// Debug: Verificar que Bootstrap est√© cargado
	if (typeof bootstrap === 'undefined') {
		console.warn('Bootstrap no est√° disponible');
	} else {
		console.log('Bootstrap cargado correctamente');
	}
	// Resumen minimalista y elegante del √∫ltimo proceso
	function cargarUltimoProcesoMini() {
		fetch('/analisis/estado/', {headers: {'X-Requested-With': 'XMLHttpRequest'}})
		.then(r => r.json())
		.then(data => {
			const cont = document.getElementById('ultimo-proceso-mini');
			// Usar data.result si existe, si no data.progreso
			let info = data.result || (data.progreso && Object.keys(data.progreso).length ? data.progreso : null);
			if (!info || !info.dominio) {
				cont.innerHTML = '';
				return;
			}
			console.log('[LAST_PROCESS] Estado del √∫ltimo proceso:', data.status, info);
			
			let color = 'secondary', estado = 'Desconocido', icon = '';
			if (data.status === 'SUCCESS') {
				color = 'success'; estado = 'Finalizado Exitosamente';
				icon = `<svg xmlns='http://www.w3.org/2000/svg' width='18' height='18' fill='currentColor' class='bi bi-check-circle-fill me-1' viewBox='0 0 16 16'><path d='M16 8A8 8 0 1 1 0 8a8 8 0 0 1 16 0zM6.97 11.03a.75.75 0 0 0 1.07 0l3.992-3.992a.75.75 0 1 0-1.06-1.06L7.5 9.439 6.03 7.97a.75.75 0 1 0-1.06 1.06l1.5 1.5z'/></svg>`;
			} else if (data.status === 'FAILURE') {
				color = 'danger'; estado = 'Error';
				icon = `<svg xmlns='http://www.w3.org/2000/svg' width='18' height='18' fill='currentColor' class='bi bi-x-circle-fill me-1' viewBox='0 0 16 16'><path d='M16 8A8 8 0 1 1 0 8a8 8 0 0 1 16 0zM4.646 4.646a.5.5 0 0 1 .708 0L8 7.293l2.646-2.647a.5.5 0 0 1 .708.708L8.707 8l2.647 2.646a.5.5 0 0 1-.708.708L8 8.707l-2.646 2.647a.5.5 0 0 1-.708-.708L7.293 8 4.646 5.354a.5.5 0 0 1 0-.708z'/></svg>`;
			} else if (data.status === 'REVOKED') {
				color = 'warning'; estado = 'Cancelado';
				icon = `<svg xmlns='http://www.w3.org/2000/svg' width='18' height='18' fill='currentColor' class='bi bi-exclamation-triangle-fill me-1' viewBox='0 0 16 16'><path d='M8 0c-.69 0-1.342.352-1.732.928L.165 13.233C-.226 13.81.226 14.5.893 14.5h14.214c.667 0 1.119-.69.728-1.267L9.732.928A1.99 1.99 0 0 0 8 0zm.93 4.412-1 6A.5.5 0 0 1 7.5 11h-1a.5.5 0 0 1-.5-.588l1-6A.5.5 0 0 1 7.5 4h1a.5.5 0 0 1 .5.588zM8 13a1 1 0 1 1 0-2 1 1 0 0 1 0 2z'/></svg>`;
			} else {
				color = 'info'; estado = 'En progreso';
				icon = `<svg xmlns='http://www.w3.org/2000/svg' width='18' height='18' fill='currentColor' class='bi bi-arrow-repeat me-1' viewBox='0 0 16 16'><path d='M2 2a.5.5 0 0 1 .5.5V5a.5.5 0 0 1-1 0V2.707l-.146.147a.5.5 0 0 1-.708-.708l1-1a.5.5 0 0 1 .708 0l1 1a.5.5 0 0 1-.708.708L2.5 2.707V5a.5.5 0 0 1-1 0V2.5A.5.5 0 0 1 2 2zm12 12a.5.5 0 0 1-.5-.5V11a.5.5 0 0 1 1 0v2.293l.146-.147a.5.5 0 0 1 .708.708l-1 1a.5.5 0 0 1-.708 0l-1-1a.5.5 0 0 1 .708-.708l.146.147V11a.5.5 0 0 1 1 0v2.5a.5.5 0 0 1-.5.5z'/></svg>`;
			}
			// Formatear fecha/hora a YYYY-MM-DD HH:MM:SS
			function formatFecha(fechaStr) {
				if (!fechaStr) return '';
				// Espera formato 'YYYY-MM-DD HH:MM:SS' o similar
				let d = new Date(fechaStr.replace(' ', 'T'));
				if (isNaN(d)) return fechaStr;
				let y = d.getFullYear();
				let m = (d.getMonth()+1).toString().padStart(2,'0');
				let day = d.getDate().toString().padStart(2,'0');
				let h = d.getHours().toString().padStart(2,'0');
				let min = d.getMinutes().toString().padStart(2,'0');
				let s = d.getSeconds().toString().padStart(2,'0');
				return `${y}-${m}-${day} ${h}:${min}:${s}`;
			}
			// Formatear duraci√≥n tipo '0:00:01.123456' o similar a hh:mm:ss
			function formatDuracion(dur) {
				if (!dur) return '';
				// Si es negativo o raro, mostrar '-'
				if (dur.includes('-')) return '-';
				let partes = dur.split(':');
				if (partes.length < 3) return dur;
				let h = partes[0].padStart(2,'0');
				let m = partes[1].padStart(2,'0');
				let s = partes[2].split('.')[0].padStart(2,'0');
				return `${h}:${m}:${s}`;
			}
			let fecha = info.hora_inicio ? formatFecha(info.hora_inicio) : (info.timestamp ? formatFecha(info.timestamp) : '');
			let fin = info.hora_fin ? formatFecha(info.hora_fin) : '';
			let duracion = info.duracion ? formatDuracion(info.duracion) : '';
			let dominio = info.dominio || '';
			let msg = data.error ? data.error : (data.status === 'SUCCESS' ? 'Finalizado correctamente' : '');
			cont.innerHTML = `
			<div class='card border-0 shadow-sm bg-light' style='max-width:700px;'>
				<div class='card-body p-3'>
					<h4 class='mb-2 fw-bold text-dark text-center' style='font-size:1.5rem;word-break:break-all;'>
						<span class='text-dark'>${dominio}</span>
					</h4>
					<div class='text-center p-0 m-0' style='font-size:0.85em;line-height:1.1;'>
						<span style='margin-right:10px;' class='text-dark'>ID: <strong>${info.id || ''}</strong></span>
						<span style='margin-right:10px;' class='text-dark'>Usuario: <strong>${info.usuario || '-'}</strong></span>
						<span style='margin-right:10px;' class='text-dark'>Estado: <strong>${estado}</strong></span>
						<span style='margin-right:10px;' class='text-dark'>Inicio: <strong>${fecha}</strong></span>
						${fin ? `<span style='margin-right:10px;' class='text-dark'>Fin: <strong>${fin}</strong></span>` : ''}
						${duracion ? `<span style='margin-right:10px;' class='text-dark'>Duraci√≥n: <strong>${duracion}</strong></span>` : ''}
						<span style='margin-right:10px;' class='text-dark'>URLs: <strong>${info.total_urls || 0}</strong></span>
					</div>
					<div class='text-center mt-2'><span class='text-dark'>${msg}</span></div>
				</div>
			</div>`;
		});
	}
	cargarUltimoProcesoMini();
	const checkTodos = document.getElementById('check-todos');
	const checks = document.querySelectorAll('.eliminar-checkbox');
	if (checkTodos) {
		checkTodos.addEventListener('change', function() {
			checks.forEach(chk => { chk.checked = checkTodos.checked; });
		});
	}

	// Progreso siempre visible: cargar √∫ltimo progreso si existe
	function cargarUltimoProgreso() {
		fetch('/analisis/estado/', {headers: {'X-Requested-With': 'XMLHttpRequest'}})
		.then(r => r.json())
		.then(data => {
			const barraProgreso = document.getElementById('barra-progreso');
			const spanUrls = document.getElementById('progreso-urls');
			const spanUltima = document.getElementById('progreso-ultima');
			const divProgreso = document.getElementById('progreso-crawling');
			const urlsContainer = document.getElementById('urls-encontradas');
			const urlsLista = document.getElementById('urls-lista');
			
			console.log('[SESSION] Cargando √∫ltimo progreso:', data);
			
			let total = data.progreso && data.progreso.total ? data.progreso.total : 0;
			let urls = data.progreso && data.progreso.urls ? data.progreso.urls : [];
			let ultima = urls.length > 0 ? urls[urls.length-1] : '';
			let porcentaje = data.progreso && data.progreso.porcentaje ? data.progreso.porcentaje : (total > 0 ? Math.min(100, total) : 0);
			
			// L√ìGICA CORREGIDA: Mostrar solo crawlings EN PROGRESO
			if (data.status === "PROGRESS" && total > 0) {
				// Hay crawling activo con URLs encontradas - MOSTRAR
				divProgreso.style.display = '';
				console.log('[PROGRESS] Mostrando crawling activo con', total, 'URLs encontradas');
			} else if (data.status === "PENDING" && data.progreso && data.progreso.dominio) {
				// Hay crawling iniciado pero sin URLs a√∫n - MOSTRAR
				divProgreso.style.display = '';
				console.log('[PROGRESS] Mostrando crawling iniciado esperando URLs...');
			} else {
				// No hay crawling activo (SUCCESS, FAILURE, REVOKED o sin datos) - OCULTAR
				divProgreso.style.display = 'none';
				console.log('[PROGRESS] Ocultando div - No hay crawling en progreso. Status:', data.status);
			}
			// Mostrar hora inicio, fin y duraci√≥n si existen
			let info = data.result || (data.progreso && Object.keys(data.progreso).length ? data.progreso : null);
			const barraInfo = document.getElementById('barra-info-tiempo');
			if (barraInfo && info) {
				let inicio = info.hora_inicio || '';
				let fin = info.hora_fin || '';
				let duracion = info.duracion || '';
				barraInfo.innerHTML = `<span class='text-muted me-2'>Inicio: ${inicio}</span>` +
					(fin ? `<span class='text-muted me-2'>Fin: ${fin}</span>` : '') +
					(duracion ? `<span class='text-muted'>Duraci√≥n: ${duracion}</span>` : '');
			}
			const estadoIcono = document.getElementById('progreso-estado-icono');
			// No recargar aqu√≠, solo actualizar visualmente
			if (data.status === 'SUCCESS') {
				estadoIcono.innerHTML = '<span class="badge bg-success"><svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="currentColor" class="bi bi-check-circle-fill me-1" viewBox="0 0 16 16"><path d="M16 8A8 8 0 1 1 0 8a8 8 0 0 1 16 0zM6.97 11.03a.75.75 0 0 0 1.07 0l3.992-3.992a.75.75 0 1 0-1.06-1.06L7.5 9.439 6.03 7.97a.75.75 0 1 0-1.06 1.06l1.5 1.5z"/></svg>Completado</span>';
			} else if (data.status === 'FAILURE') {
				estadoIcono.innerHTML = '<span class="badge bg-danger"><svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="currentColor" class="bi bi-x-circle-fill me-1" viewBox="0 0 16 16"><path d="M16 8A8 8 0 1 1 0 8a8 8 0 0 1 16 0zM4.646 4.646a.5.5 0 0 1 .708 0L8 7.293l2.646-2.647a.5.5 0 0 1 .708.708L8.707 8l2.647 2.646a.5.5 0 0 1-.708.708L8 8.707l-2.646 2.647a.5.5 0 0 1-.708-.708L7.293 8 4.646 5.354a.5.5 0 0 1 0-.708z"/></svg>Error</span>';
			} else if (data.status === 'REVOKED') {
				estadoIcono.innerHTML = '<span class="badge bg-warning text-dark"><svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="currentColor" class="bi bi-exclamation-triangle-fill me-1" viewBox="0 0 16 16"><path d="M8 0c-.69 0-1.342.352-1.732.928L.165 13.233C-.226 13.81.226 14.5.893 14.5h14.214c.667 0 1.119-.69.728-1.267L9.732.928A1.99 1.99 0 0 0 8 0zm.93 4.412-1 6A.5.5 0 0 1 7.5 11h-1a.5.5 0 0 1-.5-.588l1-6A.5.5 0 0 1 7.5 4h1a.5.5 0 0 1 .5.588zM8 13a1 1 0 1 1 0-2 1 1 0 0 1 0 2z"/></svg>Cancelado</span>';
			} else {
				estadoIcono.innerHTML = '<span class="badge bg-info text-dark"><svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="currentColor" class="bi bi-arrow-repeat me-1" viewBox="0 0 16 16"><path d="M2 2a.5.5 0 0 1 .5.5V5a.5.5 0 0 1-1 0V2.707l-.146.147a.5.5 0 0 1-.708-.708l1-1a.5.5 0 0 1 .708 0l1 1a.5.5 0 0 1-.708.708L2.5 2.707V5a.5.5 0 0 1-1 0V2.5A.5.5 0 0 1 2 2zm12 12a.5.5 0 0 1-.5-.5V11a.5.5 0 0 1 1 0v2.293l.146-.147a.5.5 0 0 1 .708.708l-1 1a.5.5 0 0 1-.708 0l-1-1a.5.5 0 0 1 .708-.708l.146.147V11a.5.5 0 0 1 1 0v2.5a.5.5 0 0 1-.5.5z"/></svg>En progreso</span>';
			}
			
			// Actualizar barra de progreso
			barraProgreso.style.width = porcentaje + '%';
			barraProgreso.textContent = porcentaje + '%';
			spanUrls.textContent = 'URLs encontradas: ' + total;
			spanUltima.textContent = ultima ? '√öltima: ' + ultima : '';
			
			// Si hay URLs, mostrar la lista completa
			if (urls.length > 0) {
				urlsContainer.style.display = 'block';
				urlsLista.innerHTML = urls.map((url, index) => 
					`<div class="d-flex justify-content-between align-items-center py-1 border-bottom" style="border-bottom: 1px solid #dee2e6 !important;">
						<span class="badge bg-secondary me-2" style="min-width: 35px;">${index + 1}</span>
						<a href="${url}" target="_blank" class="text-decoration-none flex-grow-1 text-truncate" title="${url}">
							<small>${url}</small>
						</a>
						<span class="text-success ms-2">‚úì</span>
					</div>`
				).join('');
			} else {
				urlsContainer.style.display = 'none';
			}
		});
	}
	cargarUltimoProgreso();

	// Verificar crawling activo al cargar la p√°gina
	function verificarCrawlingActivo() {
		console.log('[SESSION] Verificando crawlings activos al cargar p√°gina...');
		fetch('/crawling/activo/')
			.then(response => response.json())
			.then(data => {
				console.log('[SESSION] Respuesta crawling activo:', data);
				if (data.active) {
					console.log('[SESSION] Crawling activo detectado, restaurando progreso...');
					// Hay un crawling activo, mostrar progreso
					divProgreso.style.display = '';
					document.getElementById('urls-encontradas').style.display = 'block';
					
					// Iniciar polling para seguir el progreso
					if (polling) clearInterval(polling);
					polling = setInterval(() => {
						fetch(`/crawling/progreso/?progress_key=${data.progress_key}`)
							.then(r => r.json())
							.then(prog => {
								actualizarProgreso(prog);
								if (prog.done) {
									clearInterval(polling);
									console.log('[SESSION] Crawling completado, recargando p√°gina...');
									setTimeout(() => { window.location.reload(); }, 1200);
								}
							})
							.catch(err => {
								console.error('[SESSION] Error en polling:', err);
								clearInterval(polling);
							});
					}, 1000);
					
					// Mostrar progreso inicial
					actualizarProgreso(data);
				} else {
					console.log('[SESSION] No hay crawlings activos detectados por /crawling/activo/');
					// Ocultar el div de progreso ya que no hay crawling activo
					document.getElementById('progreso-crawling').style.display = 'none';
					console.log('[SESSION] Div de progreso ocultado - no hay crawlings activos');
				}
			})
			.catch(error => {
				console.log('[SESSION] Error verificando crawlings activos:', error);
				// En caso de error, no forzar ocultar - cargarUltimoProgreso manejar√° la visibilidad
				console.log('[SESSION] Error en verificaci√≥n, cargarUltimoProgreso determinar√° visibilidad');
			});
	}
	


	// Funci√≥n para actualizar el progreso
	function actualizarProgreso(prog) {
		let count = prog.count || 0;
		let done = prog.done;
		let last = prog.last || '';
		let urls = prog.urls || [];
		let percent = done ? 100 : Math.min(99, count);
		
		barraProgreso.style.width = percent + '%';
		barraProgreso.textContent = percent + '%';
		spanUrls.textContent = `URLs encontradas: ${count}`;
		spanUltima.textContent = last ? `√öltima: ${last}` : '';
		
		// Mostrar/ocultar bot√≥n de detener seg√∫n el estado
		const btnDetener = document.getElementById('btn-detener-crawling');
		if (btnDetener) {
			btnDetener.style.display = done ? 'none' : 'block';
		}
		
		// Mostrar URLs encontradas en tiempo real
		if (urls.length > 0) {
			const urlsContainer = document.getElementById('urls-encontradas');
			const urlsLista = document.getElementById('urls-lista');
			urlsContainer.style.display = 'block';
			
			urlsLista.innerHTML = urls.map((url, index) => 
				`<div class="d-flex justify-content-between align-items-center py-1 border-bottom" style="border-bottom: 1px solid #dee2e6 !important;">
					<span class="badge bg-secondary me-2" style="min-width: 35px;">${index + 1}</span>
					<a href="${url}" target="_blank" class="text-decoration-none flex-grow-1 text-truncate" title="${url}">
						<small>${url}</small>
					</a>
					<span class="text-success ms-2">‚úì</span>
				</div>`
			).join('');
			
			// Scroll autom√°tico al final para mostrar las URLs m√°s recientes
			urlsLista.scrollTop = urlsLista.scrollHeight;
		}
	}

	// AJAX crawling con progreso (igual que antes)
	const formCrawling = document.getElementById('form-crawling');
	const barraProgreso = document.getElementById('barra-progreso');
	const divProgreso = document.getElementById('progreso-crawling');
	const spanUrls = document.getElementById('progreso-urls');
	const spanUltima = document.getElementById('progreso-ultima');
	let polling = null;

	// Verificar al cargar la p√°gina
	document.addEventListener('DOMContentLoaded', verificarCrawlingActivo);

	formCrawling.addEventListener('submit', function(e) {
		e.preventDefault();
		const formData = new FormData(formCrawling);
		barraProgreso.style.width = '0%';
		barraProgreso.textContent = '0%';
		spanUrls.textContent = 'URLs encontradas: 0';
		spanUltima.textContent = '';
		// Mostrar la tarjeta de progreso al iniciar una nueva b√∫squeda
		divProgreso.style.display = '';
		if (polling) clearInterval(polling);

		fetch('/crawling/iniciar/', {
			method: 'POST',
			headers: {
				'X-CSRFToken': formData.get('csrfmiddlewaretoken')
			},
			body: formData
		})
		.then(resp => resp.json())
		.then(data => {
			if (data.progress_key) {
				polling = setInterval(() => {
					fetch(`/crawling/progreso/?progress_key=${data.progress_key}`)
						.then(r => r.json())
						.then(prog => {
							actualizarProgreso(prog);
							if (prog.done) {
								clearInterval(polling);
								// Recargar la p√°gina para mostrar los datos actualizados
								setTimeout(() => { window.location.reload(); }, 1200);
							}
						});
				}, 1000);
			}
		});
	});
	
	// JavaScript para formulario m√∫ltiple
	const formCrawlingMultiple = document.getElementById('form-crawling-multiple');
	let pollingMultiple = null;

	if (formCrawlingMultiple) {
		formCrawlingMultiple.addEventListener('submit', function(e) {
			e.preventDefault();
			const formData = new FormData(formCrawlingMultiple);
			
			// Validar textarea
			const dominiosText = formData.get('dominios_multiple').trim();
			if (!dominiosText) {
				alert('Por favor, ingresa al menos un dominio.');
				return;
			}
			
			// Contar l√≠neas no vac√≠as
			const dominios = dominiosText.split('\n').filter(d => d.trim()).length;
			if (dominios > 10) {
				alert('M√°ximo 10 dominios permitidos.');
				return;
			}
			
			// Crear modal de progreso para m√∫ltiples dominios
			if (pollingMultiple) clearInterval(pollingMultiple);
			
			// Crear modal din√°mico
			const modalHtml = `
				<div class="modal fade" id="modalProgresoMultiple" tabindex="-1" aria-hidden="true">
					<div class="modal-dialog modal-lg">
						<div class="modal-content">
							<div class="modal-header">
								<h5 class="modal-title">
									<i class="bi bi-lightning-charge text-warning me-2"></i>
									An√°lisis M√∫ltiple en Progreso
								</h5>
								<button type="button" class="btn-close" data-bs-dismiss="modal"></button>
							</div>
							<div class="modal-body">
								<div class="progress mb-3" style="height: 20px;">
									<div id="progreso-multiple-barra" class="progress-bar progress-bar-striped progress-bar-animated bg-info" 
										 style="width: 0%;">0%</div>
								</div>
								<div id="progreso-multiple-info" class="mb-3">
									<div class="row">
										<div class="col-6">
											<small class="text-muted">Dominios completados:</small>
											<span id="dominios-completados" class="fw-bold">0</span>/<span id="dominios-totales" class="fw-bold">0</span>
										</div>
										<div class="col-6">
											<small class="text-muted">Procesando:</small>
											<span id="dominio-actual" class="fw-bold text-primary">-</span>
										</div>
									</div>
								</div>
								<div id="resultados-multiple" class="mt-3">
									<h6 class="mb-2">Resultados:</h6>
									<div id="lista-resultados" class="list-group list-group-flush">
										<!-- Resultados din√°micos -->
									</div>
								</div>
							</div>
							<div class="modal-footer">
								<button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
								<button type="button" id="btn-recargar" class="btn btn-primary" onclick="window.location.reload();" style="display: none;">
									<i class="bi bi-arrow-clockwise me-1"></i>Ver Resultados
								</button>
							</div>
						</div>
					</div>
				</div>
			`;
			
			// Insertar modal en el DOM
			document.body.insertAdjacentHTML('beforeend', modalHtml);
			const modal = new bootstrap.Modal(document.getElementById('modalProgresoMultiple'));
			modal.show();
			
			// Limpiar modal al cerrar
			document.getElementById('modalProgresoMultiple').addEventListener('hidden.bs.modal', function() {
				this.remove();
				if (pollingMultiple) clearInterval(pollingMultiple);
			});
			
			// Iniciar crawling m√∫ltiple
			fetch('/crawling/multiple/iniciar/', {
				method: 'POST',
				headers: {
					'X-CSRFToken': formData.get('csrfmiddlewaretoken')
				},
				body: formData
			})
			.then(resp => resp.json())
			.then(data => {
				if (data.error) {
					alert('Error: ' + data.error);
					modal.hide();
					return;
				}
				
				if (data.progress_key) {
					document.getElementById('dominios-totales').textContent = data.total_domains;
					
					pollingMultiple = setInterval(() => {
						fetch(`/crawling/progreso/?progress_key=${data.progress_key}`)
							.then(r => r.json())
							.then(prog => {
								if (prog.type === 'multiple') {
									const completados = prog.completed_domains;
									const total = prog.total_domains;
									const actual = prog.current_domain || '-';
									const done = prog.done;
									const results = prog.results || {};
									
									// Actualizar progreso
									const percent = done ? 100 : Math.min(99, (completados / total) * 100);
									document.getElementById('progreso-multiple-barra').style.width = percent + '%';
									document.getElementById('progreso-multiple-barra').textContent = Math.round(percent) + '%';
									document.getElementById('dominios-completados').textContent = completados;
									document.getElementById('dominio-actual').textContent = actual;
									
									// Actualizar lista de resultados
									const listaResultados = document.getElementById('lista-resultados');
									listaResultados.innerHTML = '';
									
									Object.keys(results).forEach(dominio => {
										const result = results[dominio];
										let estadoClase = 'secondary';
										let estadoTexto = 'Procesando...';
										let icono = '<i class="bi bi-clock text-muted"></i>';
										
										if (result.status === 'error') {
											estadoClase = 'danger';
											estadoTexto = 'Error';
											icono = '<i class="bi bi-x-circle text-danger"></i>';
										} else if (result.urls_count !== undefined) {
											if (result.urls_count > 0) {
												estadoClase = 'success';
												estadoTexto = `${result.urls_count} URLs`;
												icono = '<i class="bi bi-check-circle text-success"></i>';
											} else {
												estadoClase = 'warning';
												estadoTexto = '0 URLs (bloqueado/error)';
												icono = '<i class="bi bi-shield-exclamation text-warning"></i>';
											}
										}
										
										const item = document.createElement('div');
										item.className = 'list-group-item d-flex justify-content-between align-items-center';
										item.innerHTML = `
											<div>
												${icono}
												<span class="ms-2 fw-bold">${dominio}</span>
											</div>
											<span class="badge bg-${estadoClase}">${estadoTexto}</span>
										`;
										listaResultados.appendChild(item);
									});
									
									if (done) {
										document.getElementById('progreso-multiple-barra').classList.remove('progress-bar-animated');
										document.getElementById('dominio-actual').textContent = 'Finalizado';
										document.getElementById('btn-recargar').style.display = 'inline-block';
										clearInterval(pollingMultiple);
									}
								}
							})
							.catch(err => {
								console.error('Error polling:', err);
								clearInterval(pollingMultiple);
							});
					}, 2000); // Polling cada 2 segundos para m√∫ltiples
				}
			})
			.catch(err => {
				alert('Error de conexi√≥n: ' + err.message);
				modal.hide();
			});
		});
	}
	
	// Manejar las pesta√±as correctamente
	const tabButtons = document.querySelectorAll('[data-bs-toggle="pill"]');
	tabButtons.forEach(button => {
		button.addEventListener('click', function(e) {
			e.preventDefault();
			
			// Remover clases activas de todas las pesta√±as y contenido
			tabButtons.forEach(btn => btn.classList.remove('active'));
			document.querySelectorAll('.tab-pane').forEach(pane => {
				pane.classList.remove('show', 'active');
			});
			
			// Activar la pesta√±a clickeada
			this.classList.add('active');
			
			// Mostrar el contenido correspondiente
			const targetId = this.getAttribute('data-bs-target');
			const targetPane = document.querySelector(targetId);
			if (targetPane) {
				targetPane.classList.add('show', 'active');
			}
			
			// Limpiar formularios cuando se cambie de pesta√±a
			if (targetId === '#pills-individual') {
				document.getElementById('id_dominio').value = '';
				document.getElementById('id_limite_urls').value = '';
			} else if (targetId === '#pills-multiple') {
				document.getElementById('id_dominios_multiple').value = '';
				document.getElementById('id_limite_urls_multiple').value = '50';
			}
		});
	});
	

	
	// Inicializar tooltips de Bootstrap
	const tooltipTriggerList = document.querySelectorAll('[data-bs-toggle="tooltip"]');
	const tooltipList = [...tooltipTriggerList].map(tooltipTriggerEl => new bootstrap.Tooltip(tooltipTriggerEl));
});

// Funci√≥n global para cargar ejemplos r√°pidos
function cargarEjemplos(tipo) {
	const textarea = document.getElementById('id_dominios_multiple');
	let ejemplos = '';
	
	switch(tipo) {
		case 'gubernamentales':
			ejemplos = `argentina.gob.ar
bna.com.ar
afip.gob.ar
anses.gob.ar`;
			break;
		case 'medios':
			ejemplos = `infobae.com
lanacion.com.ar
clarin.com
pagina12.com.ar`;
			break;
		case 'tecnologia':
			ejemplos = `mercadolibre.com.ar
globant.com
despegar.com
tiendamia.com`;
			break;
	}
	
	if (textarea) {
		textarea.value = ejemplos;
		textarea.focus();
	}
}

// Event listener para el bot√≥n detener
document.addEventListener('DOMContentLoaded', function() {
	const btnDetener = document.getElementById('btn-detener-crawling');
	if (btnDetener) {
		btnDetener.addEventListener('click', function() {
			detenerCrawling();
		});
	}
});

// Funci√≥n para detener crawling
function detenerCrawling() {
	if (!confirm('¬øEst√°s seguro de que quieres detener el crawling actual?')) {
		return;
	}
	
	const btnDetener = document.getElementById('btn-detener-crawling');
	if (!btnDetener) {
		alert('No se encontr√≥ el bot√≥n detener');
		return;
	}
	
	btnDetener.disabled = true;
	btnDetener.innerHTML = '<i class="bi bi-hourglass me-1"></i>Deteniendo...';
	
	fetch('/crawling/detener/', {
		method: 'POST',
		headers: {
			'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
			'Content-Type': 'application/json'
		}
	})
	.then(response => response.json())
	.then(data => {
		console.log('Respuesta detener crawling:', data);
		if (data.success) {
			alert('‚úÖ Crawling detenido: ' + (data.dominio || 'exitosamente'));
			if (typeof polling !== 'undefined' && polling) {
				clearInterval(polling);
			}
			// Recargar p√°gina para mostrar estado actualizado
			setTimeout(() => { window.location.reload(); }, 1000);
		} else {
			alert('‚ùå Error: ' + (data.error || 'No se pudo detener el crawling'));
			btnDetener.disabled = false;
			btnDetener.innerHTML = '<i class="bi bi-stop-circle me-1"></i>Detener';
		}
	})
	.catch(error => {
		console.error('Error deteniendo crawling:', error);
		alert('‚ùå Error de conexi√≥n al detener el crawling');
		btnDetener.disabled = false;
		btnDetener.innerHTML = '<i class="bi bi-stop-circle me-1"></i>Detener';
	});
}

</script>
{% endblock %}