

{% extends "base.html" %}
{% load static %}

{% block title %}Dashboard Institucional | PrestaLab{% endblock %}
{% block main_class %}dashboard-institucional{% endblock %}

{% block content %}
<div class="container py-5">

    <!-- Estad칤sticas de Dominios Bloqueados -->
    {% if blocked_stats %}
    <div class="row mb-5">
        <div class="col-12">
            <h2 class="text-center mb-4">
                <i class="bi bi-shield-fill-check me-2"></i>
                Estado del Sistema de Crawling (칔ltimas 24h)
            </h2>
        </div>
        <div class="col-md-3 mb-3">
            <div class="card border-primary">
                <div class="card-body text-center">
                    <i class="bi bi-search display-4 text-primary mb-2"></i>
                    <h4 class="text-primary">{{ blocked_stats.total_searches }}</h4>
                    <p class="text-muted mb-0">B칰squedas Totales</p>
                </div>
            </div>
        </div>
        <div class="col-md-3 mb-3">
            <div class="card border-success">
                <div class="card-body text-center">
                    <i class="bi bi-check-circle-fill display-4 text-success mb-2"></i>
                    <h4 class="text-success">{{ blocked_stats.successful_domains }}</h4>
                    <p class="text-muted mb-0">Dominios Exitosos</p>
                </div>
            </div>
        </div>
        <div class="col-md-3 mb-3">
            <div class="card border-warning">
                <div class="card-body text-center">
                    <i class="bi bi-clock-fill display-4 text-warning mb-2"></i>
                    <h4 class="text-warning">{{ blocked_stats.timeout_domains }}</h4>
                    <p class="text-muted mb-0">Timeouts/Conexi칩n</p>
                </div>
            </div>
        </div>
        <div class="col-md-3 mb-3">
            <div class="card border-danger">
                <div class="card-body text-center">
                    <i class="bi bi-shield-fill-x display-4 text-danger mb-2"></i>
                    <h4 class="text-danger">{{ blocked_stats.blocked_domains }}</h4>
                    <p class="text-muted mb-0">Dominios Bloqueados</p>
                </div>
            </div>
        </div>
        
        {% if blocked_stats.common_blocked %}
        <div class="col-12 mt-4">
            <div class="alert alert-info">
                <h6><i class="bi bi-info-circle me-2"></i>Dominios frecuentemente bloqueados:</h6>
                <p class="mb-0">
                    {% for domain in blocked_stats.common_blocked %}
                        <span class="badge bg-secondary me-2">{{ domain }}</span>
                    {% endfor %}
                </p>
                <small class="text-muted">Estos dominios tienen protecci칩n anti-bot activa y es normal que retornen 0 URLs.</small>
            </div>
        </div>
        {% endif %}
    </div>
    {% endif %}

    <!-- Tarjetas de M칩dulos Principales -->
    <div class="row">
        <!-- M칩dulo: Usuarios -->
        <div class="col-md-4 mb-4">
            <div class="card card-destacada h-100">
                <div class="card-header d-flex align-items-center">
                    <i class="fas fa-user-shield me-2"></i>
                    <span>Gesti칩n de Usuarios</span>
                </div>
                <div class="card-body">
                    <h5 class="card-title mb-3">Control de Accesos y Permisos</h5>
                    <p class="card-text">Administra usuarios, roles y niveles de acceso al sistema PrestaLab.</p>
                    <div class="mt-4">
                        <div class="d-flex justify-content-between mb-2">
                            <small>Usuarios Activos</small>
                            <small class="fw-bold">{% if user_count %}{{ user_count }}{% else %}N/A{% endif %}</small>
                        </div>
                        <div class="d-flex justify-content-between">
                            <small>칔ltimo Acceso</small>
                            <small>{% now "d/m H:i" %}</small>
                        </div>
                    </div>
                    <div class="mt-4">
                        <a href="/usuarios/editar/" class="btn btn-success w-100">
                            <i class="fas fa-users-cog me-1"></i>Administrar Usuarios
                        </a>
                    </div>
                </div>
                <div class="card-footer text-center">
                    <small class="text-white-50">
                        <i class="fas fa-lock me-1"></i>Acceso Restringido
                    </small>
                </div>
            </div>
        </div>
        <!-- M칩dulo: An치lisis de Dominio -->
        <div class="col-md-4 mb-4">
            <div class="card h-100">
                <div class="card-header d-flex align-items-center">
                    <i class="fas fa-globe me-2"></i>
                    <span>An치lisis de Dominio</span>
                </div>
                <div class="card-body">
                    <h5 class="card-title mb-3">Exploraci칩n Completa de Sitios Web</h5>
                    <p class="card-text">Extrae el sitemap, analiza todas las URLs y genera reportes exhaustivos de dominios completos.</p>
                    <ul class="list-unstyled mt-4">
                        <li class="mb-2">
                            <i class="fas fa-check-circle text-success me-2"></i>
                            Extracci칩n de sitemap.xml
                        </li>
                        <li class="mb-2">
                            <i class="fas fa-check-circle text-success me-2"></i>
                            Crawleo completo de URLs
                        </li>
                        <li class="mb-3">
                            <i class="fas fa-check-circle text-success me-2"></i>
                            An치lisis de estructura del sitio
                        </li>
                    </ul>
                    <div class="mt-3">
                        <a href="/analisis/dominio/" class="btn btn-primary w-100">
                            <i class="fas fa-search me-1"></i>Iniciar An치lisis
                        </a>
                    </div>
                </div>
                <div class="card-footer">
                    <small class="text-gris">
                        <i class="fas fa-clock me-1"></i>Tiempo estimado: 2-5 minutos
                    </small>
                </div>
            </div>
        </div>
        <!-- M칩dulo: An치lisis de URL -->
        <div class="col-md-4 mb-4">
            <div class="card h-100">
                <div class="card-header d-flex align-items-center">
                    <i class="fas fa-link me-2"></i>
                    <span>An치lisis de URL</span>
                </div>
                <div class="card-body">
                    <h5 class="card-title mb-3">Evaluaci칩n Detallada por URL</h5>
                    <p class="card-text">Analiza SEO, accesibilidad, enlaces, formularios y m칠tricas t칠cnicas de URLs espec칤ficas.</p>
                    <div class="mt-4">
                        <h6>M칠tricas Analizadas:</h6>
                        <div class="row text-center mt-3">
                            <div class="col-4">
                                <div class="metric-badge bg-info">
                                    <i class="fas fa-search"></i>
                                    <small>SEO</small>
                                </div>
                            </div>
                            <div class="col-4">
                                <div class="metric-badge bg-warning">
                                    <i class="fas fa-universal-access"></i>
                                    <small>Accesibilidad</small>
                                </div>
                            </div>
                            <div class="col-4">
                                <div class="metric-badge bg-success">
                                    <i class="fas fa-bolt"></i>
                                    <small>Performance</small>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="mt-4">
                        <a href="/analisis/url/" class="btn btn-warning w-100">
                            <i class="fas fa-chart-line me-1"></i>Analizar URL
                        </a>
                    </div>
                </div>
                <div class="card-footer">
                    <small class="text-gris">
                        <i class="fas fa-bolt me-1"></i>An치lisis en tiempo real
                    </small>
                </div>
            </div>
        </div>
    </div>

    <!-- Panel de Actividad Reciente -->
    <div class="row mt-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <span><i class="fas fa-history me-2"></i>Actividad Reciente</span>
                    <a href="/actividad/" class="btn btn-sm btn-outline-secondary">
                        Ver Historial Completo
                    </a>
                </div>
                <div class="card-body">
                    {% if ultimos_analisis %}
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>Tipo</th>
                                    <th>URL/Dominio</th>
                                    <th>Fecha</th>
                                    <th>Estado</th>
                                    <th>Acciones</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for analisis in ultimos_analisis|slice:":5" %}
                                <tr>
                                    <td>
                                        {% if analisis.tipo == 'dominio' %}
                                        <span class="badge bg-primary">Dominio</span>
                                        {% else %}
                                        <span class="badge bg-warning">URL</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <small>{{ analisis.url|truncatechars:40 }}</small>
                                    </td>
                                    <td>{{ analisis.fecha|date:"d/m H:i" }}</td>
                                    <td>
                                        {% if analisis.completado %}
                                        <span class="badge bg-success">Completado</span>
                                        {% else %}
                                        <span class="badge bg-secondary">En Proceso</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <a href="/reporte/{{ analisis.id }}/" class="btn btn-sm btn-outline-primary">
                                            <i class="fas fa-eye"></i>
                                        </a>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% else %}
                    <div class="text-center py-4">
                        <i class="fas fa-inbox fa-3x text-gris mb-3"></i>
                        <p class="text-gris">No hay an치lisis recientes</p>
                        <p class="small">Comienza analizando un dominio o URL espec칤fica</p>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- Acciones R치pidas -->
    <div class="row mt-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <i class="fas fa-bolt me-2"></i>Acciones R치pidas
                </div>
                <div class="card-body">
                    <div class="row g-3">
                        <div class="col-sm-6 col-md-4 col-lg-2">
                            <a href="/analisis/url/?quick=true" 
                               class="btn btn-outline-primary w-100 p-3 d-flex flex-column align-items-center">
                                <i class="fas fa-link fa-2x mb-2"></i>
                                <span>URL R치pida</span>
                            </a>
                        </div>
                        <div class="col-sm-6 col-md-4 col-lg-2">
                            <a href="/analisis/dominio/?quick=true" 
                               class="btn btn-outline-success w-100 p-3 d-flex flex-column align-items-center">
                                <i class="fas fa-sitemap fa-2x mb-2"></i>
                                <span>Dominio R치pido</span>
                            </a>
                        </div>
                        <div class="col-sm-6 col-md-4 col-lg-2">
                            <a href="/reportes/nuevo/" 
                               class="btn btn-outline-info w-100 p-3 d-flex flex-column align-items-center">
                                <i class="fas fa-file-export fa-2x mb-2"></i>
                                <span>Nuevo Reporte</span>
                            </a>
                        </div>
                        <div class="col-sm-6 col-md-4 col-lg-2">
                            <a href="/usuarios/nuevo/" 
                               class="btn btn-outline-warning w-100 p-3 d-flex flex-column align-items-center">
                                <i class="fas fa-user-plus fa-2x mb-2"></i>
                                <span>Nuevo Usuario</span>
                            </a>
                        </div>
                        <div class="col-sm-6 col-md-4 col-lg-2">
                            <button onclick="alert('Exportando configuraci칩n actual...')" 
                                    class="btn btn-outline-secondary w-100 p-3 d-flex flex-column align-items-center">
                                <i class="fas fa-download fa-2x mb-2"></i>
                                <span>Exportar Data</span>
                            </button>
                        </div>
                        <div class="col-sm-6 col-md-4 col-lg-2">
                            <a href="/soporte/" 
                               class="btn btn-outline-danger w-100 p-3 d-flex flex-column align-items-center">
                                <i class="fas fa-headset fa-2x mb-2"></i>
                                <span>Soporte</span>
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
    .metric-badge {
        padding: 8px 5px;
        border-radius: 8px;
        color: white;
        font-size: 0.8rem;
        display: flex;
        flex-direction: column;
        align-items: center;
    }
    .metric-badge i {
        font-size: 1.2rem;
        margin-bottom: 5px;
    }
    .dashboard-link .badge {
        font-size: 0.7rem;
        padding: 0.25rem 0.5rem;
    }
</style>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Efectos interactivos para el dashboard
    const dashboardLinks = document.querySelectorAll('.dashboard-link');
    dashboardLinks.forEach(link => {
        link.addEventListener('mouseenter', function() {
            this.style.transform = 'translateY(-4px)';
            this.style.boxShadow = '0 8px 20px rgba(36,44,79,0.15)';
        });
        link.addEventListener('mouseleave', function() {
            this.style.transform = 'translateY(0)';
            this.style.boxShadow = '0 2px 8px rgba(36,44,79,0.07)';
        });
    });
    // Efectos para las cards
    const cards = document.querySelectorAll('.card');
    cards.forEach(card => {
        card.addEventListener('mouseenter', function() {
            this.style.transform = 'translateY(-2px)';
            this.style.transition = 'all 0.3s ease';
        });
        card.addEventListener('mouseleave', function() {
            this.style.transform = 'translateY(0)';
        });
    });
    // Actualizar hora del sistema
    function updateSystemTime() {
        const timeElements = document.querySelectorAll('.system-time');
        const now = new Date();
        const timeString = now.toLocaleTimeString('es-ES', { 
            hour: '2-digit', 
            minute: '2-digit',
            second: '2-digit'
        });
        timeElements.forEach(el => {
            el.textContent = timeString;
        });
    }
    // Actualizar cada segundo
    setInterval(updateSystemTime, 1000);
    updateSystemTime();
    // Notificaci칩n de bienvenida para nuevos usuarios
    const isNewUser = sessionStorage.getItem('prestalabFirstVisit');
    if (!isNewUser && window.location.pathname === '/') {
        setTimeout(() => {
            console.log('游꿀 춰Bienvenido a PrestaLab Dashboard!');
            sessionStorage.setItem('prestalabFirstVisit', 'true');
        }, 1000);
    }
});
</script>
{% endblock %}
